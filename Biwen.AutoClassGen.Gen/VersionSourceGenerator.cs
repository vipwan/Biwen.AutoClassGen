using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System.IO;
using System.Text.RegularExpressions;
using System.Text;

namespace Biwen.AutoClassGen;

/// <summary>
/// 生成版本信息
/// </summary>
[Generator]
public class VersionSourceGenerator : IIncrementalGenerator
{
    private const string DefaultVersion = "1.0.0";

    private readonly record struct VersionInfo(string? Namespace, string? File);

    #region regex

    private static readonly Regex VersionRegex = new(@"<Version>(.*?)</Version>", RegexOptions.Compiled);
    private static readonly Regex FileVersionRegex = new(@"<FileVersion>(.*?)</FileVersion>", RegexOptions.Compiled);
    private static readonly Regex AssemblyVersionRegex = new(@"<AssemblyVersion>(.*?)</AssemblyVersion>", RegexOptions.Compiled);
    private static readonly Regex ImportRegex = new(@"<Import Project=""(.*?)""", RegexOptions.Compiled);

    #endregion


    public void Initialize(IncrementalGeneratorInitializationContext context)
    {
        //build_property.projectdir

        //生成版本号
        var inc = context.AnalyzerConfigOptionsProvider.Select((pvd, _) =>
        {
            //取得项目目录
            var flag = pvd.GlobalOptions.TryGetValue("build_property.projectdir", out var root);
            if (!flag)
                return new VersionInfo(null, null);

            //取得命名空间
            pvd.GlobalOptions.TryGetValue("build_property.rootnamespace", out var @namespace);

            //查找csproj文件
            var files = Directory.GetFiles(root, "*.csproj", SearchOption.TopDirectoryOnly);

            return new VersionInfo(@namespace, files.Length == 0 ? null : files[0]);
        });

        //生成
        context.RegisterSourceOutput(inc, (ctx, info) =>
        {
            if (info.Namespace == null || info.File == null)
                return;

            string version = DefaultVersion;
            string fileVersion = DefaultVersion;
            string assemblyVersion = DefaultVersion;

            // 获取不含扩展名的文件名
            //var @namespace = Path.GetFileNameWithoutExtension(info.Item2);

            // 读取文件
            var text = File.ReadAllText(info.File);

            // 载入Import的文件,例如 : <Import Project="..\Version.props" />
            // 使用正则表达式匹配Project:
            var importMatchs = ImportRegex.Matches(text);

            foreach (Match importMatch in importMatchs)
            {
                var importFile = Path.Combine(Path.GetDirectoryName(info.File), importMatch.Groups[1].Value);
                if (File.Exists(importFile))
                {
                    text += File.ReadAllText(importFile);
                }
            }

            var match = VersionRegex.Match(text);
            var fileVersionMatch = FileVersionRegex.Match(text);
            var assemblyVersionMatch = AssemblyVersionRegex.Match(text);
            if (match.Success)
            {
                version = match.Groups[1].Value;
            }
            if (fileVersionMatch.Success)
            {
                fileVersion = fileVersionMatch.Groups[1].Value;
            }
            if (assemblyVersionMatch.Success)
            {
                assemblyVersion = assemblyVersionMatch.Groups[1].Value;
            }

            string source = $@"// <auto-generated/>
namespace {info.Namespace}.Generated;

/// <summary>
/// The version class
/// </summary>
public static class Version
{{
    /// <summary>
    /// The current version
    /// </summary>
    public static System.Version Current => System.Version.Parse(""{version}"");

    /// <summary>
    /// The file version
    /// </summary>
    public static System.Version FileVersion => System.Version.Parse(""{fileVersion}"");

    /// <summary>
    /// The assembly version
    /// </summary>
    public static System.Version AssemblyVersion => System.Version.Parse(""{assemblyVersion}"");
}}
";
            // 输出代码
            ctx.AddSource("version.g.cs", SourceText.From(source.FormatContent(), Encoding.UTF8));
        });
    }
}